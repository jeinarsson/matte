(* Content-type: application/vnd.wolfram.mathematica *)

(*** Wolfram Notebook File ***)
(* http://www.wolfram.com/nb *)

(* CreatedBy='Mathematica 11.0' *)

(*CacheID: 234*)
(* Internal cache information:
NotebookFileLineBreakTest
NotebookFileLineBreakTest
NotebookDataPosition[       158,          7]
NotebookDataLength[     67695,       1890]
NotebookOptionsPosition[     64805,       1784]
NotebookOutlinePosition[     65165,       1800]
CellTagsIndexPosition[     65122,       1797]
WindowFrame->Normal*)

(* Beginning of Notebook Content *)
Notebook[{
Cell["\<\
These are the functions we developed in tutorial01-tutorial03.\
\>", "Section",
 InitializationCell->True,
 CellChangeTimes->{{3.706464784734717*^9, 3.7064648040753613`*^9}}],

Cell[CellGroupData[{

Cell["Algebraic manipulation functions", "Title",
 InitializationCell->True,
 CellChangeTimes->{{3.704130693471868*^9, 3.704130702051206*^9}}],

Cell[CellGroupData[{

Cell["Index handling", "Subchapter",
 InitializationCell->True,
 CellChangeTimes->{{3.704130707436162*^9, 3.704130709854192*^9}}],

Cell[CellGroupData[{

Cell["Generating new indices", "Subsection",
 InitializationCell->True,
 CellChangeTimes->{{3.704130720034691*^9, 3.704130724187181*^9}}],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"gHighestIndex", "=", "20"}], ";"}], " ", 
  RowBox[{"(*", 
   RowBox[{
    RowBox[{"idx", "[", "1", "]"}], " ", "to", " ", 
    RowBox[{"idx", "[", "20", "]"}], " ", "are", " ", "reserved", " ", "for", 
    " ", "manual", " ", "input"}], "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"getNewIndex", "[", "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"gHighestIndex", " ", "=", " ", 
       RowBox[{"gHighestIndex", " ", "+", " ", "1"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"idx", "[", "gHighestIndex", "]"}]}]}], "\[IndentingNewLine]", 
    "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"getNewIndex", "[", "n_Integer", "]"}], ":=", 
  RowBox[{"Table", "[", 
   RowBox[{
    RowBox[{"getNewIndex", "[", "]"}], ",", 
    RowBox[{"{", 
     RowBox[{"k", ",", "1", ",", "n"}], "}"}]}], 
   "]"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"getLastIndex", "[", "]"}], ":=", 
   RowBox[{"idx", "[", "gHighestIndex", "]"}]}], ";"}]}], "Input",
 InitializationCell->True]
}, Closed]],

Cell[CellGroupData[{

Cell["Renaming dummy indices and applying symmetries", "Subsection",
 InitializationCell->True,
 CellChangeTimes->{{3.7041307291562223`*^9, 3.704130760061783*^9}, {
  3.705342175465098*^9, 3.705342179483642*^9}}],

Cell[BoxData[
 RowBox[{"\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{"Clear", "[", 
     RowBox[{
     "renumber", ",", "renumberUnique", ",", "\[IndentingNewLine]", " ", 
      "symmetryRules", ",", "\[IndentingNewLine]", "symmetricTensorPattern", 
      ",", "antisymmetricTensorPattern", ",", "tracelessTensorPattern"}], 
     "]"}], ";"}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"symmetricTensorPattern", " ", "=", 
     RowBox[{"delta", "|", "e"}]}], ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"antisymmetricTensorPattern", "=", "o"}], ";"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"tracelessTensorPattern", "=", "e"}], ";"}], " ", 
   "\[IndentingNewLine]", "\[IndentingNewLine]", 
   RowBox[{"(*", " ", 
    RowBox[{
     RowBox[{
     "The", " ", "symmetry", " ", "rules", " ", "shuffles", " ", "indices", 
      " ", "into", " ", "sorted", " ", "order"}], ",", " ", 
     RowBox[{
     "and", " ", "in", " ", "case", " ", "of", " ", "antisymmetric", " ", 
      "tensors", " ", "multiplies", " ", "with", " ", 
      RowBox[{"(", 
       RowBox[{"-", "1"}], ")"}]}]}], " ", "*)"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"symmetryRules", "=", 
     RowBox[{"{", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{
        RowBox[{"s_", "[", 
         RowBox[{"before___", ",", 
          RowBox[{"ii", ":", 
           RowBox[{"idx", "[", "i_Integer", "]"}]}], ",", 
          RowBox[{"jj", ":", 
           RowBox[{"idx", "[", "j_Integer", "]"}]}], ",", "after___"}], "]"}],
         "\[RuleDelayed]", 
        RowBox[{
         RowBox[{"s", "[", 
          RowBox[{"before", ",", "jj", ",", "ii", ",", "after"}], "]"}], "/;", 
         RowBox[{
          RowBox[{"j", "<", "i"}], "&&", 
          RowBox[{"MatchQ", "[", 
           RowBox[{"s", ",", "symmetricTensorPattern"}], "]"}]}]}]}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"s_", "[", 
         RowBox[{
         "before___", ",", "i_Integer", ",", "j_Integer", ",", "after___"}], 
         "]"}], "\[RuleDelayed]", 
        RowBox[{
         RowBox[{"s", "[", 
          RowBox[{"before", ",", "j", ",", "i", ",", "after"}], "]"}], "/;", 
         RowBox[{
          RowBox[{"j", "<", "i"}], "&&", 
          RowBox[{"MatchQ", "[", 
           RowBox[{"s", ",", "symmetricTensorPattern"}], "]"}]}]}]}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"s_", "[", 
         RowBox[{"before___", ",", 
          RowBox[{"ii", ":", 
           RowBox[{"idx", "[", "i_Integer", "]"}]}], ",", 
          RowBox[{"jj", ":", 
           RowBox[{"idx", "[", "j_Integer", "]"}]}], ",", "after___"}], "]"}],
         "\[RuleDelayed]", 
        RowBox[{
         RowBox[{"-", 
          RowBox[{"s", "[", 
           RowBox[{"before", ",", "jj", ",", "ii", ",", "after"}], "]"}]}], "/;", 
         RowBox[{
          RowBox[{"j", "<", "i"}], "&&", 
          RowBox[{"MatchQ", "[", 
           RowBox[{"s", ",", "antisymmetricTensorPattern"}], "]"}]}]}]}], ",",
        "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"s_", "[", 
         RowBox[{
         "before___", ",", "i_Integer", ",", "j_Integer", ",", "after___"}], 
         "]"}], "\[RuleDelayed]", 
        RowBox[{
         RowBox[{"-", 
          RowBox[{"s", "[", 
           RowBox[{"before", ",", "j", ",", "i", ",", "after"}], "]"}]}], "/;", 
         RowBox[{
          RowBox[{"j", "<", "i"}], "&&", 
          RowBox[{"MatchQ", "[", 
           RowBox[{"s", ",", "antisymmetricTensorPattern"}], "]"}]}]}]}], ",",
        "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"s_", "[", 
         RowBox[{"___", ",", "i_idx", ",", "___", ",", "i_idx", ",", "___"}], 
         "]"}], "\[RuleDelayed]", 
        RowBox[{"0", "/;", 
         RowBox[{
          RowBox[{"MatchQ", "[", 
           RowBox[{"s", ",", "tracelessTensorPattern"}], "]"}], " ", "||", 
          " ", 
          RowBox[{"MatchQ", "[", 
           RowBox[{"s", ",", "antisymmetricTensorPattern"}], "]"}]}]}]}]}], 
      "\[IndentingNewLine]", "}"}]}], ";"}], "\[IndentingNewLine]", 
   "\[IndentingNewLine]", 
   RowBox[{"(*", " ", 
    RowBox[{
     RowBox[{"Don", "'"}], "t", " ", "renumber", " ", "if", " ", "there", " ",
      "are", " ", "no", " ", "indices"}], " ", "*)"}], "\[IndentingNewLine]", 
   
   RowBox[{
    RowBox[{"renumber", "[", "ex_", "]"}], ":=", 
    RowBox[{"ex", "/;", 
     RowBox[{"FreeQ", "[", 
      RowBox[{"ex", ",", "idx"}], "]"}]}]}], "\[IndentingNewLine]", 
   "\[IndentingNewLine]", 
   RowBox[{"(*", " ", 
    RowBox[{"Map", " ", "over", " ", "terms", " ", "in", " ", "sums"}], " ", 
    "*)"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"renumber", "[", "ex_Plus", "]"}], ":=", 
    RowBox[{"Map", "[", 
     RowBox[{"renumber", ",", "ex"}], "]"}]}], "\[IndentingNewLine]", 
   "\[IndentingNewLine]", 
   RowBox[{"(*", " ", 
    RowBox[{
     RowBox[{"If", " ", "free", " ", "of", " ", "sums"}], ",", " ", 
     RowBox[{"do", " ", "actual", " ", "renumbering"}]}], " ", "*)"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"renumber", "[", "expr_", "]"}], ":=", 
    RowBox[{
     RowBox[{"Module", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
        "ex", ",", "exidxs", ",", "\[IndentingNewLine]", "allidx", ",", 
         "idxWithCounts", ",", "freeIndices", ",", "dummyIndices", ",", 
         "highestFreeIndex", ",", "\[IndentingNewLine]", "newDummyIndices", 
         ",", "dummyPositions", ",", "dummyOrdering", ",", "dummyRules"}], 
        "}"}], ",", "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"ex", "=", 
         RowBox[{"expr", "//.", "symmetryRules"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"exidxs", "=", 
         RowBox[{"ex", "/.", 
          RowBox[{
           RowBox[{
            RowBox[{"s_", "[", 
             RowBox[{"idxsequence", ":", 
              RowBox[{"_idx", ".."}]}], "]"}], "^", "2"}], "\[RuleDelayed]", 
           RowBox[{"idxs", "[", 
            RowBox[{"idxsequence", ",", "idxsequence"}], "]"}]}]}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"allidx", "=", 
         RowBox[{"Cases", "[", 
          RowBox[{"exidxs", ",", 
           RowBox[{"idx", "[", "i_Integer", "]"}], ",", "Infinity", ",", 
           RowBox[{"Heads", "\[Rule]", "True"}]}], "]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"idxWithCounts", "=", 
         RowBox[{"Tally", "[", "allidx", "]"}]}], ";", "\[IndentingNewLine]", 
        
        RowBox[{"freeIndices", "=", 
         RowBox[{"First", "/@", 
          RowBox[{"Select", "[", 
           RowBox[{"idxWithCounts", ",", " ", 
            RowBox[{
             RowBox[{
              RowBox[{"#", "[", 
               RowBox[{"[", "2", "]"}], "]"}], "\[Equal]", "1"}], "&"}]}], 
           "]"}]}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"dummyIndices", "=", 
         RowBox[{"First", "/@", 
          RowBox[{"Select", "[", 
           RowBox[{"idxWithCounts", ",", " ", 
            RowBox[{
             RowBox[{
              RowBox[{"#", "[", 
               RowBox[{"[", "2", "]"}], "]"}], "\[Equal]", "2"}], "&"}]}], 
           "]"}]}]}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
        RowBox[{"highestFreeIndex", " ", "=", " ", 
         RowBox[{"If", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"Length", "[", "freeIndices", "]"}], ">", "0"}], ",", 
           "\[IndentingNewLine]", 
           RowBox[{"Max", "[", 
            RowBox[{"freeIndices", "/.", 
             RowBox[{
              RowBox[{"idx", "[", "n_", "]"}], ":>", "n"}]}], "]"}], ",", 
           "\[IndentingNewLine]", "0"}], "]"}]}], ";", "\[IndentingNewLine]", 
        "\[IndentingNewLine]", 
        RowBox[{"newDummyIndices", "=", 
         RowBox[{"Table", "[", 
          RowBox[{
           RowBox[{"idx", "[", 
            RowBox[{"highestFreeIndex", "+", "k"}], "]"}], ",", 
           RowBox[{"{", 
            RowBox[{"k", ",", "1", ",", 
             RowBox[{"Length", "[", "dummyIndices", "]"}]}], "}"}]}], "]"}]}],
         ";", "\[IndentingNewLine]", 
        RowBox[{"dummyPositions", "=", 
         RowBox[{
          RowBox[{
           RowBox[{"(", 
            RowBox[{"Position", "[", 
             RowBox[{"ex", ",", "#"}], "]"}], ")"}], "&"}], "/@", 
          "dummyIndices"}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"dummyPositions", "=", 
         RowBox[{"Map", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"If", "[", 
             RowBox[{
              RowBox[{
               RowBox[{"Length", "[", "#", "]"}], ">", "1"}], ",", 
              RowBox[{"First", "/@", "#"}], ",", 
              RowBox[{"First", "[", "#", "]"}]}], "]"}], "&"}], ",", 
           "dummyPositions"}], "]"}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"dummyOrdering", "=", 
         RowBox[{"Ordering", "[", "dummyPositions", "]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"dummyRules", " ", "=", " ", 
         RowBox[{"Table", "[", "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{
            RowBox[{"dummyIndices", "[", 
             RowBox[{"[", 
              RowBox[{"dummyOrdering", "[", 
               RowBox[{"[", "k", "]"}], "]"}], "]"}], "]"}], "\[Rule]", 
            RowBox[{"newDummyIndices", "[", 
             RowBox[{"[", "k", "]"}], "]"}]}], "\[IndentingNewLine]", ",", 
           RowBox[{"{", 
            RowBox[{"k", ",", "1", ",", 
             RowBox[{"Length", "[", "dummyIndices", "]"}]}], "}"}]}], "]"}]}],
         ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"(", 
          RowBox[{"ex", "/.", "dummyRules"}], ")"}], "//.", 
         "symmetryRules"}]}]}], "\[IndentingNewLine]", "]"}], "/;", " ", 
     RowBox[{"FreeQ", "[", 
      RowBox[{"ex", ",", 
       RowBox[{"_Plus", "?", 
        RowBox[{"(", 
         RowBox[{
          RowBox[{"Not", "[", 
           RowBox[{"FreeQ", "[", 
            RowBox[{"#", ",", "idx"}], "]"}], "]"}], "&"}], ")"}]}]}], 
      "]"}]}]}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
   RowBox[{"(*", " ", 
    RowBox[{
     RowBox[{"Don", "'"}], "t", " ", "renumber", " ", "if", " ", "there", " ",
      "are", " ", "no", " ", "indices"}], " ", "*)"}], "\[IndentingNewLine]", 
   
   RowBox[{
    RowBox[{"renumberUnique", "[", "ex_", "]"}], ":=", 
    RowBox[{"ex", "/;", 
     RowBox[{"FreeQ", "[", 
      RowBox[{"ex", ",", "idx"}], "]"}]}]}], "\[IndentingNewLine]", 
   "\[IndentingNewLine]", 
   RowBox[{"(*", " ", 
    RowBox[{"Map", " ", "over", " ", "terms", " ", "in", " ", "sums"}], " ", 
    "*)"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"renumberUnique", "[", "ex_Plus", "]"}], ":=", 
    RowBox[{"Map", "[", 
     RowBox[{"renumberUnique", ",", "ex"}], "]"}]}], "\[IndentingNewLine]", 
   "\[IndentingNewLine]", 
   RowBox[{"(*", " ", 
    RowBox[{
     RowBox[{"If", " ", "free", " ", "of", " ", "sums"}], ",", " ", 
     RowBox[{"do", " ", "actual", " ", "renumbering"}]}], " ", "*)"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"renumberUnique", "[", "expr_", "]"}], ":=", 
    RowBox[{
     RowBox[{"Module", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
        "ex", ",", "exidxs", ",", "\[IndentingNewLine]", "allidx", ",", 
         "idxWithCounts", ",", "freeIndices", ",", "dummyIndices", ",", 
         "\[IndentingNewLine]", "newDummyIndices", ",", "dummyPositions", ",",
          "dummyOrdering", ",", "dummyRules"}], "}"}], ",", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"ex", "=", 
         RowBox[{"expr", "//.", "symmetryRules"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"exidxs", "=", 
         RowBox[{"ex", "/.", 
          RowBox[{
           RowBox[{
            RowBox[{"s_", "[", 
             RowBox[{"idxsequence", ":", 
              RowBox[{"_idx", ".."}]}], "]"}], "^", "2"}], "\[RuleDelayed]", 
           RowBox[{"idxs", "[", 
            RowBox[{"idxsequence", ",", "idxsequence"}], "]"}]}]}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"allidx", "=", 
         RowBox[{"Cases", "[", 
          RowBox[{"exidxs", ",", 
           RowBox[{"idx", "[", "i_Integer", "]"}], ",", "Infinity", ",", 
           RowBox[{"Heads", "\[Rule]", "True"}]}], "]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"idxWithCounts", "=", 
         RowBox[{"Tally", "[", "allidx", "]"}]}], ";", "\[IndentingNewLine]", 
        
        RowBox[{"freeIndices", "=", 
         RowBox[{"First", "/@", 
          RowBox[{"Select", "[", 
           RowBox[{"idxWithCounts", ",", " ", 
            RowBox[{
             RowBox[{
              RowBox[{"#", "[", 
               RowBox[{"[", "2", "]"}], "]"}], "\[Equal]", "1"}], "&"}]}], 
           "]"}]}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"dummyIndices", "=", 
         RowBox[{"First", "/@", 
          RowBox[{"Select", "[", 
           RowBox[{"idxWithCounts", ",", " ", 
            RowBox[{
             RowBox[{
              RowBox[{"#", "[", 
               RowBox[{"[", "2", "]"}], "]"}], "\[Equal]", "2"}], "&"}]}], 
           "]"}]}]}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
        RowBox[{"newDummyIndices", "=", 
         RowBox[{"Table", "[", 
          RowBox[{
           RowBox[{"getNewIndex", "[", "]"}], ",", 
           RowBox[{"{", 
            RowBox[{"k", ",", "1", ",", 
             RowBox[{"Length", "[", "dummyIndices", "]"}]}], "}"}]}], "]"}]}],
         ";", "\[IndentingNewLine]", 
        RowBox[{"dummyPositions", "=", 
         RowBox[{
          RowBox[{
           RowBox[{"(", 
            RowBox[{"Position", "[", 
             RowBox[{"ex", ",", "#"}], "]"}], ")"}], "&"}], "/@", 
          "dummyIndices"}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"dummyPositions", "=", 
         RowBox[{"Map", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"If", "[", 
             RowBox[{
              RowBox[{
               RowBox[{"Length", "[", "#", "]"}], ">", "1"}], ",", 
              RowBox[{"First", "/@", "#"}], ",", 
              RowBox[{"First", "[", "#", "]"}]}], "]"}], "&"}], ",", 
           "dummyPositions"}], "]"}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"dummyOrdering", "=", 
         RowBox[{"Ordering", "[", "dummyPositions", "]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"dummyRules", " ", "=", " ", 
         RowBox[{"Table", "[", "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{
            RowBox[{"dummyIndices", "[", 
             RowBox[{"[", 
              RowBox[{"dummyOrdering", "[", 
               RowBox[{"[", "k", "]"}], "]"}], "]"}], "]"}], "\[Rule]", 
            RowBox[{"newDummyIndices", "[", 
             RowBox[{"[", "k", "]"}], "]"}]}], "\[IndentingNewLine]", ",", 
           RowBox[{"{", 
            RowBox[{"k", ",", "1", ",", 
             RowBox[{"Length", "[", "dummyIndices", "]"}]}], "}"}]}], "]"}]}],
         ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"(", 
          RowBox[{"ex", "/.", "dummyRules"}], ")"}], "//.", 
         "symmetryRules"}]}]}], "\[IndentingNewLine]", "]"}], "/;", " ", 
     RowBox[{"FreeQ", "[", 
      RowBox[{"ex", ",", 
       RowBox[{"_Plus", "?", 
        RowBox[{"(", 
         RowBox[{
          RowBox[{"Not", "[", 
           RowBox[{"FreeQ", "[", 
            RowBox[{"#", ",", "idx"}], "]"}], "]"}], "&"}], ")"}]}]}], 
      "]"}]}]}], "\[IndentingNewLine]"}]}]], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.704129163035516*^9, 3.7041291645583057`*^9}, {
   3.704553722163183*^9, 3.7045537267968607`*^9}, {3.7045581120176888`*^9, 
   3.704558130536849*^9}, 3.705342169523727*^9, {3.7053422008102207`*^9, 
   3.705342251747821*^9}, {3.705343116038957*^9, 3.705343123188883*^9}, {
   3.7053432513681087`*^9, 3.705343258903041*^9}, {3.7053720079737988`*^9, 
   3.70537206624516*^9}, {3.705672751040719*^9, 3.705672767612247*^9}, {
   3.705687797798705*^9, 3.705687836853509*^9}, {3.705846975234715*^9, 
   3.705847029231649*^9}, 3.705847100474732*^9, {3.705847395167316*^9, 
   3.705847437506521*^9}, {3.705856268316284*^9, 3.705856270670425*^9}, {
   3.705856601577499*^9, 3.705856602401718*^9}, {3.705952007048499*^9, 
   3.7059520081279383`*^9}, {3.705952973909396*^9, 3.705952981983045*^9}, 
   3.706464301871657*^9, {3.7064644049254093`*^9, 3.7064644541802893`*^9}}]
}, Closed]]
}, Open  ]],

Cell[CellGroupData[{

Cell["Contraction and manipulation", "Subchapter",
 InitializationCell->True,
 CellChangeTimes->{{3.704130770893281*^9, 3.70413078040031*^9}}],

Cell[CellGroupData[{

Cell["Differentiation", "Subsection",
 InitializationCell->True,
 CellChangeTimes->{{3.705769939336821*^9, 3.70576994186506*^9}}],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"Clear", "[", "partialr", "]"}], ";"}], "\[IndentingNewLine]", 
  "\[IndentingNewLine]", 
  RowBox[{"(*", " ", 
   RowBox[{
    RowBox[{"Nest", " ", "multiple", " ", "derivatives"}], ",", " ", 
    RowBox[{
     RowBox[{"eg", " ", 
      RowBox[{"partialr", "[", 
       RowBox[{"ex", ",", " ", 
        RowBox[{"{", 
         RowBox[{"i", ",", "j"}], "}"}]}], "]"}]}], "=", 
     RowBox[{"partialr", "[", 
      RowBox[{
       RowBox[{"partialr", "[", 
        RowBox[{"ex", ",", "i"}], "]"}], ",", "j"}], "]"}]}]}], 
   "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"partialr", "[", 
    RowBox[{"ex_", ",", "idxs_List"}], "]"}], ":=", 
   RowBox[{"Fold", "[", 
    RowBox[{"partialr", ",", "ex", ",", "idxs"}], "]"}]}], " ", 
  "\[IndentingNewLine]", "\[IndentingNewLine]", 
  RowBox[{"(*", " ", 
   RowBox[{"differentiation", " ", "rules"}], " ", 
   "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"partialr", "[", 
    RowBox[{"ex_Plus", ",", "i_"}], "]"}], ":=", 
   RowBox[{"Map", "[", 
    RowBox[{
     RowBox[{
      RowBox[{"partialr", "[", 
       RowBox[{"#", ",", "i"}], "]"}], "&"}], ",", "ex"}], "]"}]}], " ", 
  RowBox[{"(*", "Linearity", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"partialr", "[", 
    RowBox[{"ex_Times", ",", "i_"}], "]"}], ":=", 
   RowBox[{
    RowBox[{
     RowBox[{"Take", "[", 
      RowBox[{"ex", ",", "1"}], "]"}], 
     RowBox[{"partialr", "[", 
      RowBox[{
       RowBox[{"Drop", "[", 
        RowBox[{"ex", ",", "1"}], "]"}], ",", "i"}], "]"}]}], "+", 
    RowBox[{
     RowBox[{"Drop", "[", 
      RowBox[{"ex", ",", "1"}], "]"}], 
     RowBox[{"partialr", "[", 
      RowBox[{
       RowBox[{"Take", "[", 
        RowBox[{"ex", ",", "1"}], "]"}], ",", "i"}], "]"}]}]}]}], 
  RowBox[{"(*", 
   RowBox[{"Product", " ", "rule"}], "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"partialr", "[", 
    RowBox[{"ex_", ",", "i_"}], "]"}], ":=", 
   RowBox[{"0", "/;", 
    RowBox[{"FreeQ", "[", 
     RowBox[{"ex", ",", 
      RowBox[{"invr", "|", "r", "|", "rhat"}]}], "]"}]}]}], " ", 
  RowBox[{"(*", " ", 
   RowBox[{
    RowBox[{"derivative", " ", "of", " ", "constants", " ", "wrt", " ", "r"}],
     " ", "=", " ", "0"}], " ", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"partialr", "[", 
    RowBox[{
     RowBox[{"invr", "[", "m_", "]"}], ",", "i_"}], "]"}], ":=", 
   RowBox[{
    RowBox[{"-", "m"}], " ", 
    RowBox[{"r", "[", "i", "]"}], 
    RowBox[{"invr", "[", 
     RowBox[{"m", "+", "2"}], "]"}]}]}], " ", 
  RowBox[{"(*", " ", 
   RowBox[{"1", "/", 
    RowBox[{"r", "^", "m"}]}], " ", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"partialr", "[", 
    RowBox[{
     RowBox[{"r", "[", "i_", "]"}], ",", "j_"}], "]"}], ":=", 
   RowBox[{"delta", "[", 
    RowBox[{"i", ",", "j"}], "]"}]}], " ", 
  RowBox[{"(*", " ", "r_i", " ", "*)"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"laplacer", "[", "ex_", "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", "j", "}"}], ",", 
    RowBox[{
     RowBox[{"j", "=", 
      RowBox[{"getNewIndex", "[", "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"partialr", "[", 
      RowBox[{"ex", ",", 
       RowBox[{"{", 
        RowBox[{"j", ",", "j"}], "}"}]}], "]"}]}]}], "\[IndentingNewLine]", 
   "]"}]}]}], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.705343563271624*^9, 3.705343570859961*^9}, {
   3.7053436210521812`*^9, 3.705343762561563*^9}, {3.705343792614172*^9, 
   3.705343815147105*^9}, 3.705343994487314*^9, {3.705344406609436*^9, 
   3.705344542555038*^9}, {3.7053446861356077`*^9, 3.7053447288131313`*^9}, {
   3.7053447763241034`*^9, 3.705344790337997*^9}, {3.705344903867421*^9, 
   3.705344914042417*^9}, {3.705345041183897*^9, 3.705345113092868*^9}, {
   3.705345155269822*^9, 3.705345244452495*^9}, 3.7053453108150177`*^9, {
   3.7053454593410807`*^9, 3.705345523836149*^9}, {3.705345562633853*^9, 
   3.705345628525291*^9}, {3.7053464192684307`*^9, 3.705346439318918*^9}, {
   3.705350175995781*^9, 3.705350194376892*^9}, 3.7054087019731503`*^9, {
   3.705410298982497*^9, 3.705410333236785*^9}, {3.70541038002754*^9, 
   3.705410419359632*^9}, {3.7054107501555243`*^9, 3.705410769991502*^9}, {
   3.705412266820734*^9, 3.705412266993414*^9}, {3.7056651523775043`*^9, 
   3.705665217793441*^9}, {3.705760350310845*^9, 3.705760351321727*^9}, {
   3.705769947970615*^9, 3.7057699775646667`*^9}, {3.705847216537801*^9, 
   3.7058472211466837`*^9}, {3.7060213238696327`*^9, 3.7060213422939997`*^9}}]
}, Closed]],

Cell[CellGroupData[{

Cell["Tensor rules", "Subsection",
 InitializationCell->True,
 CellChangeTimes->{{3.705770002351213*^9, 3.705770004112903*^9}}],

Cell[BoxData[{
 RowBox[{
  RowBox[{"Clear", "[", 
   RowBox[{"tensorRules", ",", "transpose", ",", "trace"}], " ", "]"}], 
  "\[IndentingNewLine]", "\[IndentingNewLine]", 
  RowBox[{"(*", " ", 
   RowBox[{"tensor", " ", "rules"}], " ", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"transpose", "[", 
   RowBox[{"s", ":", "symmetricTensorPattern"}], "]"}], ":=", 
  "s"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"transpose", "[", 
   RowBox[{"s", ":", "antisymmetricTensorPattern"}], "]"}], ":=", 
  RowBox[{"-", "s"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"trace", "[", 
   RowBox[{"before___", ",", 
    RowBox[{"-", "x_"}], ",", "after___"}], "]"}], ":=", 
  RowBox[{"-", 
   RowBox[{"trace", "[", 
    RowBox[{"before", ",", "x", ",", "after"}], 
    "]"}]}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"trace", "[", "tracelessTensorPattern", "]"}], ":=", "0"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"trace", "[", "antisymmetricTensorPattern", "]"}], ":=", "0"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"trace", "[", 
   RowBox[{"delta", ".."}], "]"}], ":=", "3"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"tensorRules", "=", 
   RowBox[{"{", "\[IndentingNewLine]", 
    RowBox[{"(*", " ", 
     RowBox[{"treat", " ", 
      RowBox[{"invr", "'"}], "s"}], " ", "*)"}], "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{
      RowBox[{
       RowBox[{"r", "[", "i_idx", "]"}], "^", "2"}], "\[RuleDelayed]", 
      RowBox[{"invr", "[", 
       RowBox[{"-", "2"}], "]"}]}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{
       RowBox[{"invr", "[", "m1_", "]"}], 
       RowBox[{"invr", "[", "m2_", "]"}]}], "\[RuleDelayed]", 
      RowBox[{"invr", "[", 
       RowBox[{"m1", "+", "m2"}], "]"}]}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{
       RowBox[{"invr", "[", "m_", "]"}], "^", "n_"}], "\[RuleDelayed]", 
      RowBox[{"invr", "[", 
       RowBox[{"m", " ", "n"}], "]"}]}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"invr", "[", "0", "]"}], "\[RuleDelayed]", "1"}], ",", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
      "contract", " ", "deltas", " ", "with", " ", "other", " ", "tensors"}], 
      " ", "*)"}], "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{
       RowBox[{"delta", "[", 
        RowBox[{"i_", ",", "j_idx"}], "]"}], "s_"}], " ", "\[RuleDelayed]", 
      " ", 
      RowBox[{
       RowBox[{"(", 
        RowBox[{"s", "/.", 
         RowBox[{"j", "\[Rule]", "i"}]}], ")"}], "/;", 
       RowBox[{"Not", "[", 
        RowBox[{"FreeQ", "[", 
         RowBox[{"s", ",", "j"}], "]"}], "]"}]}]}], ",", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{
       RowBox[{"delta", "[", 
        RowBox[{"j_idx", ",", "i_"}], "]"}], "s_"}], " ", "\[RuleDelayed]", 
      " ", 
      RowBox[{
       RowBox[{"(", 
        RowBox[{"s", "/.", 
         RowBox[{"j", "\[Rule]", "i"}]}], ")"}], "/;", 
       RowBox[{"Not", "[", 
        RowBox[{"FreeQ", "[", 
         RowBox[{"s", ",", "j"}], "]"}], "]"}]}]}], ",", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
       RowBox[{"traces", " ", "&"}], " ", "squares"}], " ", "*)"}], 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{
       RowBox[{"s_", "[", "_idx", "]"}], "^", "2"}], "\[RuleDelayed]", 
      RowBox[{"sqr", "[", "s", "]"}]}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{
       RowBox[{"s_", "[", 
        RowBox[{"i_idx", ",", "j_idx"}], "]"}], "^", "2"}], "\[RuleDelayed]", 
      
      RowBox[{"trace", "[", 
       RowBox[{"s", ",", 
        RowBox[{"transpose", "[", "s", "]"}]}], "]"}]}], ",", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{
       RowBox[{"s_", "[", 
        RowBox[{"i_idx", ",", "j_idx"}], "]"}], 
       RowBox[{"s_", "[", 
        RowBox[{"j_idx", ",", "i_idx"}], "]"}]}], "\[RuleDelayed]", 
      RowBox[{"trace", "[", 
       RowBox[{"s", ",", "s"}], "]"}]}]}], "\[IndentingNewLine]", "}"}]}], 
  ";"}]}], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.705769985113913*^9, 3.705770000814679*^9}, {
  3.705770055952264*^9, 3.705770056144853*^9}, {3.705856628212199*^9, 
  3.7058567220079117`*^9}, {3.705952023569352*^9, 3.705952258691451*^9}, {
  3.7059526830480213`*^9, 3.7059526895709763`*^9}, {3.7059527435475616`*^9, 
  3.7059527695058107`*^9}, {3.7060377820431423`*^9, 3.70603779685922*^9}, {
  3.706464106142459*^9, 3.7064641085182333`*^9}, {3.7064644840959053`*^9, 
  3.706464561236557*^9}}]
}, Closed]],

Cell[CellGroupData[{

Cell["Contract function", "Subsection",
 InitializationCell->True,
 CellChangeTimes->{{3.7057699912374077`*^9, 3.705769996695066*^9}, {
  3.705856725992484*^9, 3.7058567270483294`*^9}}],

Cell[BoxData[{
 RowBox[{
  RowBox[{"Clear", "[", 
   RowBox[{"contract", ",", " ", "contractNoRenumber"}], "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"tensorAndSymmetryRules", "=", 
    RowBox[{"Join", "[", 
     RowBox[{"tensorRules", ",", "symmetryRules"}], "]"}]}], ";"}], 
  "\[IndentingNewLine]", "\[IndentingNewLine]", 
  RowBox[{"(*", " ", 
   RowBox[{"distribute", " ", "over", " ", "terms", " ", "in", " ", "sum"}], 
   " ", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"contractNoRenumber", "[", "ex_Plus", "]"}], ":=", " ", 
    RowBox[{"Map", "[", 
     RowBox[{"contractNoRenumber", ",", "ex"}], "]"}]}], ";"}], 
  "\[IndentingNewLine]", "\[IndentingNewLine]", 
  RowBox[{"(*", " ", 
   RowBox[{
    RowBox[{"If", " ", "no", " ", "sums", " ", "in", " ", "expression"}], ",",
     " ", 
    RowBox[{"apply", " ", "tensorRules", " ", "until", " ", "convergence"}]}],
    " ", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"contractNoRenumber", "[", "ex_", "]"}], ":=", "  ", 
    RowBox[{
     RowBox[{"FixedPoint", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"Expand", "[", 
         RowBox[{"#", "/.", "tensorAndSymmetryRules"}], "]"}], "&"}], ",", 
       "ex"}], "]"}], "/;", " ", 
     RowBox[{"FreeQ", "[", 
      RowBox[{"ex", ",", 
       RowBox[{"_Plus", "?", 
        RowBox[{"(", 
         RowBox[{
          RowBox[{"Not", "[", 
           RowBox[{"FreeQ", "[", 
            RowBox[{"#", ",", "idx"}], "]"}], "]"}], "&"}], ")"}]}]}], 
      "]"}]}]}], ";"}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
  RowBox[{"(*", " ", 
   RowBox[{
    RowBox[{"If", " ", "there", " ", "are", " ", "sums"}], ",", " ", 
    RowBox[{"Expand", " ", "and", " ", "try", " ", "again"}]}], " ", 
   "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"contractNoRenumber", "[", "ex_", "]"}], ":=", " ", 
    RowBox[{"contractNoRenumber", "[", 
     RowBox[{"Expand", "[", "ex", "]"}], "]"}]}], ";"}], 
  "\[IndentingNewLine]", "\[IndentingNewLine]", 
  RowBox[{"(*", " ", 
   RowBox[{
    RowBox[{"Main", " ", 
     RowBox[{"function", ":", " ", 
      RowBox[{"contract", " ", "first"}]}]}], ",", " ", 
    RowBox[{"then", " ", "renumber", " ", "result"}]}], " ", 
   "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"contract", "[", "ex_", "]"}], ":=", " ", 
   RowBox[{"renumber", "[", 
    RowBox[{"contractNoRenumber", "[", "ex", "]"}], "]"}]}], ";"}]}], "Input",\

 InitializationCell->True,
 CellChangeTimes->{{3.705888575023919*^9, 3.7058885973288918`*^9}}]
}, Closed]]
}, Open  ]],

Cell[CellGroupData[{

Cell["Pretty printing", "Subchapter",
 InitializationCell->True,
 CellChangeTimes->{{3.705668243437153*^9, 3.705668244763443*^9}, {
  3.705769684169477*^9, 3.7057696907284517`*^9}}],

Cell[CellGroupData[{

Cell["Split expressions into scalars & tensorial components", "Subsection",
 InitializationCell->True,
 CellChangeTimes->{{3.7057696155099573`*^9, 3.705769628455557*^9}}],

Cell[BoxData[{
 RowBox[{
  RowBox[{"Clear", "[", "splitScalarsTensors", "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"splitScalarsTensors", "[", "ex_Times", "]"}], ":=", 
   RowBox[{
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", "temp", "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
       "gather", " ", "scalar", " ", "and", " ", "tensorial", " ", "part"}], 
       " ", "*)"}], "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"temp", "=", 
        RowBox[{"GroupBy", "[", 
         RowBox[{
          RowBox[{"List", "@@", "ex"}], ",", 
          RowBox[{"(", 
           RowBox[{
            RowBox[{"FreeQ", "[", 
             RowBox[{"#", ",", "idx"}], "]"}], "&"}], ")"}]}], "]"}]}], ";", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"(*", " ", 
        RowBox[{"multiply", " ", "factors", " ", "back", " ", "together"}], 
        " ", "*)"}], "\[IndentingNewLine]", 
       RowBox[{"temp", "=", 
        RowBox[{"Map", "[", 
         RowBox[{
          RowBox[{
           RowBox[{"Times", "@@", "#"}], "&"}], ",", "temp"}], "]"}]}], ";", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"Lookup", "[", 
          RowBox[{"temp", ",", "True", ",", "1"}], "]"}], ",", 
         RowBox[{"Lookup", "[", 
          RowBox[{"temp", ",", "False", ",", "1"}], "]"}]}], "}"}]}]}], 
     "\[IndentingNewLine]", "]"}], "/;", " ", 
    RowBox[{"FreeQ", "[", 
     RowBox[{"ex", ",", 
      RowBox[{"_Plus", "?", 
       RowBox[{"(", 
        RowBox[{
         RowBox[{"Not", "[", 
          RowBox[{"FreeQ", "[", 
           RowBox[{"#", ",", "idx"}], "]"}], "]"}], "&"}], ")"}]}]}], 
     "]"}]}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"splitScalarsTensors", "[", "ex_", "]"}], ":=", 
   RowBox[{
    RowBox[{"If", "[", 
     RowBox[{
      RowBox[{"FreeQ", "[", 
       RowBox[{"ex", ",", "idx"}], "]"}], ",", 
      RowBox[{"{", 
       RowBox[{"ex", ",", "1"}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{"1", ",", "ex"}], "}"}]}], "]"}], "/;", " ", 
    RowBox[{"FreeQ", "[", 
     RowBox[{"ex", ",", 
      RowBox[{"_Plus", "?", 
       RowBox[{"(", 
        RowBox[{
         RowBox[{"Not", "[", 
          RowBox[{"FreeQ", "[", 
           RowBox[{"#", ",", "idx"}], "]"}], "]"}], "&"}], ")"}]}]}], 
     "]"}]}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"splitScalarsTensors", "[", "ex_", "]"}], ":=", 
  RowBox[{
  "Print", "[", 
   "\"\<splitScalarsTensors: Error: Sum of tensorial expressions.\>\"", 
   "]"}]}]}], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.705668266937108*^9, 3.705668267529134*^9}, {
   3.705673397704154*^9, 3.705673421206072*^9}, {3.705673457463871*^9, 
   3.705673531386877*^9}, 3.705691142061623*^9, {3.705691175133306*^9, 
   3.7056911789522533`*^9}, {3.705691248880728*^9, 3.705691249772208*^9}, {
   3.7056912806245327`*^9, 3.705691281133123*^9}, {3.705691336457342*^9, 
   3.705691369798029*^9}, {3.705691715063531*^9, 3.705691892794937*^9}, {
   3.705691929697904*^9, 3.705692069832979*^9}, {3.705692100818351*^9, 
   3.7056921100619297`*^9}, {3.705692156919276*^9, 3.705692227428033*^9}, {
   3.7056922789691877`*^9, 3.705692313999205*^9}, 3.705760433486228*^9, {
   3.705760615648093*^9, 3.7057606163302107`*^9}, {3.7057696376162767`*^9, 
   3.7057696383668003`*^9}, {3.705777070207201*^9, 3.7057770808151493`*^9}, {
   3.705777524364984*^9, 3.705777625163641*^9}, {3.705888621389578*^9, 
   3.705888661191058*^9}, {3.7064646136266327`*^9, 3.706464617424636*^9}}]
}, Closed]],

Cell[CellGroupData[{

Cell["Pretty printing", "Subsection",
 InitializationCell->True,
 CellChangeTimes->{{3.705769680696775*^9, 3.705769694571351*^9}}],

Cell[BoxData[{
 RowBox[{
  RowBox[{"Clear", "[", 
   RowBox[{"prettyprint", ",", "prettyreplace"}], "]"}], 
  "\[IndentingNewLine]", "\[IndentingNewLine]", 
  RowBox[{"(*", " ", 
   RowBox[{
   "this", " ", "helper", " ", "function", " ", "applies", " ", "the", " ", 
    "replacement", " ", "rules"}], " ", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"prettyreplace", "[", "ex_", "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"temp", ",", "prettyindices"}], "}"}], ",", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"prettyindices", "=", 
       RowBox[{"{", 
        RowBox[{
        "i", ",", "j", ",", "k", ",", "l", ",", "p", ",", "q", ",", "r", ",", 
         "s"}], "}"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"temp", "=", 
       RowBox[{"ex", "/.", 
        RowBox[{"{", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{
           RowBox[{"invr", "[", "m_", "]"}], "\[RuleDelayed]", 
           RowBox[{"1", "/", 
            RowBox[{"r", "^", "m"}]}]}], ",", "\[IndentingNewLine]", 
          RowBox[{"delta", "\[Rule]", "\[Delta]"}], ",", 
          "\[IndentingNewLine]", 
          RowBox[{"eps", "\[Rule]", "\[Epsilon]"}]}], "\[IndentingNewLine]", 
         "}"}]}]}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{"subscript", " ", "index", " ", "notation"}], " ", "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{"temp", "=", 
       RowBox[{"temp", "/.", 
        RowBox[{
         RowBox[{"s_", "[", 
          RowBox[{"i", ":", 
           RowBox[{"_idx", ".."}]}], "]"}], "\[RuleDelayed]", 
         SubscriptBox["s", "i"]}]}]}], ";", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{"numbered", " ", "indices", " ", "to", " ", "letters"}], " ", 
       "*)"}], "\[IndentingNewLine]", 
      RowBox[{"temp", " ", "=", " ", 
       RowBox[{"temp", "/.", 
        RowBox[{"Table", "[", 
         RowBox[{
          RowBox[{
           RowBox[{"idx", "[", "c", "]"}], "\[Rule]", 
           RowBox[{"prettyindices", "[", 
            RowBox[{"[", "c", "]"}], "]"}]}], ",", 
          RowBox[{"{", 
           RowBox[{"c", ",", "1", ",", 
            RowBox[{"Length", "[", "prettyindices", "]"}]}], "}"}]}], 
         "]"}]}]}]}]}], "\[IndentingNewLine]", "]"}]}], "\[IndentingNewLine]",
   "\[IndentingNewLine]", 
  RowBox[{"(*", " ", 
   RowBox[{
   "groups", " ", "terms", " ", "by", " ", "tensorial", " ", "expression", 
    " ", "and", " ", "then", " ", "calls", " ", "prettyreplace"}], " ", 
   "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"prettyprint", "[", "ex_", "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", "temp", "}"}], ",", "\[IndentingNewLine]", 
    "\[IndentingNewLine]", 
    RowBox[{"(*", " ", 
     RowBox[{
      RowBox[{"If", " ", "not", " ", "sum"}], ",", " ", 
      RowBox[{"nothing", " ", "to", " ", "collect"}], ",", " ", 
      RowBox[{"so", " ", "just", " ", "call", " ", "prettyreplace"}]}], " ", 
     "*)"}], "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"Not", "[", 
        RowBox[{
         RowBox[{"Head", "[", "ex", "]"}], "===", "Plus"}], "]"}], ",", 
       RowBox[{"Return", "[", 
        RowBox[{"prettyreplace", "[", "ex", "]"}], "]"}]}], "]"}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
      "make", " ", "list", " ", "of", " ", "terms", " ", "in", " ", "sum"}], 
      " ", "*)"}], "\[IndentingNewLine]", 
     RowBox[{"temp", "=", 
      RowBox[{"List", "@@", "ex"}]}], ";", "\[IndentingNewLine]", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
      "split", " ", "each", " ", "term", " ", "into", " ", "scalar", " ", 
       "and", " ", "tensorial", " ", "factors"}], " ", "*)"}], 
     "\[IndentingNewLine]", 
     RowBox[{"temp", " ", "=", " ", 
      RowBox[{"splitScalarsTensors", "/@", "temp"}]}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
      "Group", " ", "terms", " ", "with", " ", "equal", " ", "tensorial", " ",
        "expressions"}], " ", "*)"}], "\[IndentingNewLine]", 
     RowBox[{"temp", " ", "=", " ", 
      RowBox[{"GroupBy", "[", 
       RowBox[{"temp", ",", "Last"}], "]"}]}], ";", "\[IndentingNewLine]", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
      "Combine", " ", "and", " ", "simplify", " ", "scalar", " ", 
       "prefactors"}], " ", "*)"}], "\[IndentingNewLine]", 
     RowBox[{"temp", " ", "=", " ", 
      RowBox[{"Map", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"Simplify", "@", 
          RowBox[{"First", "@", 
           RowBox[{"Total", "[", "#", "]"}]}]}], "&"}], ",", "temp"}], 
       "]"}]}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
      "Convert", " ", "association", " ", "back", " ", "to", " ", "normal", 
       " ", "expression"}], " ", "*)"}], "\[IndentingNewLine]", 
     RowBox[{"temp", " ", "=", 
      RowBox[{"prettyreplace", "@", " ", 
       RowBox[{"Total", "@", 
        RowBox[{"KeyValueMap", "[", 
         RowBox[{"Times", ",", "temp"}], "]"}]}]}]}]}]}], 
   "\[IndentingNewLine]", "]"}]}]}], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.705769702133906*^9, 3.705769702937767*^9}, {
  3.705777630232881*^9, 3.7057776326454573`*^9}, {3.705952657518111*^9, 
  3.7059526596150913`*^9}, {3.706464637130603*^9, 3.706464663352427*^9}}]
}, Closed]],

Cell[CellGroupData[{

Cell["Extracting scalar prefactors of expression", "Subsection",
 InitializationCell->True,
 CellChangeTimes->{{3.70576970663861*^9, 3.705769718274643*^9}}],

Cell[BoxData[{
 RowBox[{
  RowBox[{"Clear", "[", "getScalarPrefactors", "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"getScalarPrefactors", "[", "ex_", "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", "temp", "}"}], ",", "\[IndentingNewLine]", 
    "\[IndentingNewLine]", 
    RowBox[{"(*", " ", 
     RowBox[{
      RowBox[{"If", " ", "not", " ", "sum"}], ",", " ", 
      RowBox[{"nothing", " ", "to", " ", "collect"}], ",", " ", 
      RowBox[{"so", " ", "just", " ", "call", " ", "splitScalarsTensors"}]}], 
     " ", "*)"}], "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"Not", "[", 
        RowBox[{
         RowBox[{"Head", "[", "ex", "]"}], "===", "Plus"}], "]"}], ",", 
       RowBox[{"Return", "[", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"splitScalarsTensors", "[", "ex", "]"}], "[", 
          RowBox[{"[", "1", "]"}], "]"}], "}"}], "]"}]}], "]"}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
      "make", " ", "list", " ", "of", " ", "terms", " ", "in", " ", "sum"}], 
      " ", "*)"}], "\[IndentingNewLine]", 
     RowBox[{"temp", "=", 
      RowBox[{"List", "@@", "ex"}]}], ";", "\[IndentingNewLine]", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
      "split", " ", "each", " ", "term", " ", "into", " ", "scalar", " ", 
       "and", " ", "tensorial", " ", "factors"}], " ", "*)"}], 
     "\[IndentingNewLine]", 
     RowBox[{"temp", " ", "=", " ", 
      RowBox[{"splitScalarsTensors", "/@", "temp"}]}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
      "Group", " ", "terms", " ", "with", " ", "equal", " ", "tensorial", " ",
        "expressions"}], " ", "*)"}], "\[IndentingNewLine]", 
     RowBox[{"temp", " ", "=", " ", 
      RowBox[{"GroupBy", "[", 
       RowBox[{"temp", ",", "Last"}], "]"}]}], ";", "\[IndentingNewLine]", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
      "Combine", " ", "and", " ", "simplify", " ", "scalar", " ", 
       "prefactors"}], " ", "*)"}], "\[IndentingNewLine]", 
     RowBox[{"temp", " ", "=", " ", 
      RowBox[{"Map", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"Simplify", "@", 
          RowBox[{"First", "@", 
           RowBox[{"Total", "[", "#", "]"}]}]}], "&"}], ",", "temp"}], 
       "]"}]}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"Values", "[", "temp", "]"}]}]}], "\[IndentingNewLine]", 
   "]"}]}]}], "Input",
 InitializationCell->True,
 CellChangeTimes->{3.706464696041799*^9}]
}, Closed]]
}, Open  ]]
}, Open  ]],

Cell[CellGroupData[{

Cell["Integration over spherical domains", "Title",
 CellChangeTimes->{{3.706464816438197*^9, 3.7064648247265043`*^9}}],

Cell[TextData[{
 "The tensors we defined thus far have spatial dependence like ",
 Cell[BoxData[
  FormBox[
   RowBox[{
    RowBox[{
     RowBox[{
      SubscriptBox["r", "i"], 
      SubscriptBox["r", "j"]}], "..."}], 
    RowBox[{
     SubscriptBox["r", "n"], "/", 
     SuperscriptBox["r", "m"]}]}], TraditionalForm]],
  FormatType->"TraditionalForm"],
 ". Here we will implement\n\nA) the angular integral ",
 Cell[BoxData[
  FormBox[
   SuperscriptBox[
    SubscriptBox["\[Integral]", "0"], "\[Pi]"], TraditionalForm]],
  FormatType->"TraditionalForm"],
 " ",
 Cell[BoxData[
  FormBox[
   SuperscriptBox[
    SubscriptBox["\[Integral]", "0"], 
    RowBox[{"2", "\[Pi]"}]], TraditionalForm]],
  FormatType->"TraditionalForm"],
 " ",
 Cell[BoxData[
  FormBox[
   RowBox[{
    RowBox[{
     RowBox[{
      SubscriptBox["r", "i"], 
      SubscriptBox["r", "j"]}], "..."}], 
    RowBox[{
     SubscriptBox["r", "n"], "/", 
     SuperscriptBox["r", "m"]}]}], TraditionalForm]],
  FormatType->"TraditionalForm"],
 " ",
 Cell[BoxData[
  FormBox[
   SuperscriptBox["r", "2"], TraditionalForm]],
  FormatType->"TraditionalForm"],
 " sin[\[Theta]] d\[Theta] d\[Phi]\nB) the volume integral",
 Cell[BoxData[
  FormBox[
   SuperscriptBox[
    SubscriptBox["\[Integral]", "1"], "\[Infinity]"], TraditionalForm]]],
 " ",
 Cell[BoxData[
  FormBox[
   SuperscriptBox[
    SubscriptBox["\[Integral]", "0"], "\[Pi]"], TraditionalForm]]],
 Cell[BoxData[
  FormBox[
   SuperscriptBox[
    SubscriptBox["\[Integral]", "0"], 
    RowBox[{"2", "\[Pi]"}]], TraditionalForm]],
  FormatType->"TraditionalForm"],
 " ",
 Cell[BoxData[
  FormBox[
   RowBox[{
    RowBox[{
     RowBox[{
      SubscriptBox["r", "i"], 
      SubscriptBox["r", "j"]}], "..."}], 
    RowBox[{
     SubscriptBox["r", "n"], "/", 
     SuperscriptBox["r", "m"]}]}], TraditionalForm]],
  FormatType->"TraditionalForm"],
 " ",
 Cell[BoxData[
  FormBox[
   SuperscriptBox["r", "2"], TraditionalForm]],
  FormatType->"TraditionalForm"],
 " sin[\[Theta]] d\[Theta] d\[Phi] dr\n"
}], "Subsubsection",
 CellChangeTimes->{{3.706464948617284*^9, 3.706465018501891*^9}, {
  3.706465050690034*^9, 3.7064652609279203`*^9}}],

Cell[CellGroupData[{

Cell["Angular integral", "Section",
 CellChangeTimes->{{3.7064657128613234`*^9, 3.706465717753791*^9}}],

Cell[CellGroupData[{

Cell[TextData[{
 "The angular integral routine counts how many r[_idx] there are in the \
expression. If n is odd the integral vanishes. If n is even, replace with the \
general result:\n\n",
 Cell[BoxData[
  FormBox[
   RowBox[{"\[Integral]", 
    SubscriptBox["n", 
     SubscriptBox["i", "1"]]}], TraditionalForm]]],
 Cell[BoxData[
  FormBox[
   SubscriptBox["n", 
    SubscriptBox["i", "2"]], TraditionalForm]]],
 "..",
 Cell[BoxData[
  FormBox[
   SubscriptBox["n", 
    SubscriptBox["i", "n"]], TraditionalForm]]],
 "dS=K/N (N unique isotropic tensors of order n)\n\nwhere ",
 Cell[BoxData[
  FormBox[
   RowBox[{
    SubscriptBox["n", "i"], "=", 
    RowBox[{
     SubscriptBox["r", "i"], "/", "r"}]}], TraditionalForm]],
  FormatType->"TraditionalForm"],
 " .\n\nN = ",
 Cell[BoxData[
  FractionBox[
   RowBox[{
    SuperscriptBox["2", 
     RowBox[{"n", "/", "2"}]], " ", 
    RowBox[{"Gamma", "[", 
     RowBox[{
      FractionBox["1", "2"], "+", 
      FractionBox["n", "2"]}], "]"}]}], 
   SqrtBox["\[Pi]"]]],
  CellChangeTimes->{{3.7045699596699743`*^9, 3.7045700480072727`*^9}, 
    3.704570122005971*^9, 3.7045701813627872`*^9}],
 ", the number of unique symmetric pairings of n indices, given by recurrence \
relation\n",
 Cell[BoxData[
  FormBox[
   RowBox[{
    SubscriptBox["N", 
     RowBox[{"n", "+", "2"}]], "=", 
    RowBox[{
     RowBox[{"(", 
      RowBox[{"n", "+", "1"}], ")"}], 
     SubscriptBox["N", "n"]}]}], TraditionalForm]]],
 " , and ",
 Cell[BoxData[
  FormBox[
   RowBox[{
    RowBox[{
     SubscriptBox["N", "1"], "=", "0"}], ",", " ", 
    RowBox[{
     SubscriptBox["N", "2"], "=", "1"}]}], TraditionalForm]]],
 "\n(With n+2 indices there are (n+2)-1 pairings with the first index, times ",
 Cell[BoxData[
  FormBox[
   RowBox[{
    SubscriptBox["N", "n"], " ", "pairings", " ", "for", " ", "the", " ", 
    "remaining", " ", "n"}], TraditionalForm]]],
 ". Base case when only two indices = one pairing, trivially.)"
}], "Subsubsection",
 CellChangeTimes->{{3.704568581941182*^9, 3.704568673734211*^9}, {
   3.70456885594212*^9, 3.704569016427896*^9}, 3.704570295290848*^9, {
   3.704570380735909*^9, 3.704570780844707*^9}, {3.706465273045353*^9, 
   3.706465307812158*^9}, {3.706465356725543*^9, 3.706465365149284*^9}, {
   3.706465420227346*^9, 3.706465440513678*^9}, {3.706465528666746*^9, 
   3.706465659614685*^9}, {3.706465719143338*^9, 3.70646572010848*^9}}],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"a", "[", "n", "]"}], "/.", 
   RowBox[{
    RowBox[{"RSolve", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
        RowBox[{
         RowBox[{
          RowBox[{"a", "[", 
           RowBox[{"n", "+", "2"}], "]"}], "-", 
          RowBox[{
           RowBox[{"(", 
            RowBox[{"n", "+", "1"}], ")"}], 
           RowBox[{"a", "[", "n", "]"}]}]}], "\[Equal]", "0"}], ",", 
        RowBox[{
         RowBox[{"a", "[", "2", "]"}], "\[Equal]", "1"}], ",", 
        RowBox[{
         RowBox[{"a", "[", "1", "]"}], "\[Equal]", "0"}]}], "}"}], ",", 
      RowBox[{"a", "[", "n", "]"}], ",", " ", "n"}], "]"}], "[", 
    RowBox[{"[", "1", "]"}], "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"FullSimplify", "[", 
   RowBox[{
    RowBox[{"%", "/.", 
     RowBox[{"n", "\[Rule]", 
      RowBox[{"2", "k"}]}]}], ",", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"k", ">", "0"}], ",", 
      RowBox[{"k", "\[Element]", "Integers"}]}], "}"}]}], "]"}], "/.", 
  RowBox[{"k", "\[Rule]", 
   RowBox[{"n", "/", "2"}]}]}]}], "Input",
 CellChangeTimes->{{3.706465669214677*^9, 3.7064656741383467`*^9}}]
}, Open  ]],

Cell[CellGroupData[{

Cell[TextData[{
 "The remaining constant K is given by\nK = ",
 Cell[BoxData[
  FormBox[
   RowBox[{"\[Integral]", 
    RowBox[{
     SubscriptBox["n", "3"], "^", "n"}]}], TraditionalForm]]],
 " dS = 4Pi/(1+n) by integrating one of the elements of the tensor:"
}], "Subsubsection",
 CellChangeTimes->{{3.704568581941182*^9, 3.704568673734211*^9}, {
   3.70456885594212*^9, 3.704569016427896*^9}, 3.704570295290848*^9, {
   3.704570380735909*^9, 3.704570780844707*^9}, {3.706465273045353*^9, 
   3.706465307812158*^9}, {3.706465356725543*^9, 3.706465365149284*^9}, {
   3.706465420227346*^9, 3.706465440513678*^9}, {3.706465528666746*^9, 
   3.706465641887526*^9}, {3.706465685861981*^9, 3.706465689869177*^9}}],

Cell[BoxData[{
 RowBox[{
  RowBox[{"2", "Pi", " ", 
   RowBox[{"Integrate", "[", 
    RowBox[{
     RowBox[{
      RowBox[{
       RowBox[{"Cos", "[", "\[Theta]", "]"}], "^", "n"}], " ", 
      RowBox[{"Sin", "[", "\[Theta]", "]"}]}], ",", 
     RowBox[{"{", 
      RowBox[{"\[Theta]", ",", "0", ",", "Pi"}], "}"}], ",", 
     RowBox[{"Assumptions", "\[Rule]", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"n", ">", "0"}], ",", 
        RowBox[{"n", "\[Element]", "Integers"}]}], "}"}]}]}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"FullSimplify", "[", 
   RowBox[{
    RowBox[{"%", "/.", 
     RowBox[{"n", "\[Rule]", 
      RowBox[{"2", "k"}]}]}], ",", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"k", ">", "0"}], ",", 
      RowBox[{"k", "\[Element]", "Integers"}]}], "}"}]}], "]"}], "/.", 
  RowBox[{"k", "\[Rule]", 
   RowBox[{"n", "/", "2"}]}]}]}], "Input"]
}, Open  ]],

Cell[CellGroupData[{

Cell["\<\
Here is a recursive routine that enumerates unique pairings according to the \
above recurrence formula, given a list of items.\
\>", "Subsubsection",
 CellChangeTimes->{{3.704572636110929*^9, 3.7045726496284647`*^9}, {
  3.7045727257604103`*^9, 3.704572756535557*^9}, {3.705342611304243*^9, 
  3.705342612422591*^9}, {3.706465749439989*^9, 3.706465757005588*^9}, {
  3.706465815419223*^9, 3.7064658157070723`*^9}}],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"uniquePairings", "[", 
    RowBox[{"{", 
     RowBox[{"a_", ",", "b_"}], "}"}], "]"}], ":=", 
   RowBox[{"{", 
    RowBox[{"{", 
     RowBox[{"{", 
      RowBox[{"a", ",", "b"}], "}"}], "}"}], "}"}]}], " ", 
  RowBox[{"(*", " ", 
   RowBox[{
    RowBox[{"base", " ", "case", " ", "n"}], "=", "2"}], " ", 
   "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"uniquePairings", "[", "list_", "]"}], ":=", 
  RowBox[{"Flatten", "[", 
   RowBox[{
    RowBox[{"Table", "[", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"Table", "[", 
       RowBox[{
        RowBox[{"Prepend", "[", 
         RowBox[{"p", ",", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"list", "[", 
             RowBox[{"[", "1", "]"}], "]"}], ",", 
            RowBox[{"list", "[", 
             RowBox[{"[", "k", "]"}], "]"}]}], "}"}]}], "]"}], ",", 
        RowBox[{"{", 
         RowBox[{"p", ",", 
          RowBox[{"uniquePairings", "[", 
           RowBox[{"Delete", "[", 
            RowBox[{"list", ",", 
             RowBox[{"{", 
              RowBox[{
               RowBox[{"{", "1", "}"}], ",", 
               RowBox[{"{", "k", "}"}]}], "}"}]}], "]"}], "]"}]}], "}"}]}], 
       "]"}], "\[IndentingNewLine]", ",", 
      RowBox[{"{", 
       RowBox[{"k", ",", "2", ",", 
        RowBox[{"Length", "[", "list", "]"}]}], "}"}]}], "]"}], ",", "1"}], 
   "]"}]}], "\[IndentingNewLine]", 
 RowBox[{"uniquePairings", "[", 
  RowBox[{"{", 
   RowBox[{"a", ",", "b", ",", "c", ",", "d"}], "}"}], 
  "]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"uniquePairings", "[", 
    RowBox[{"Array", "[", 
     RowBox[{"a", ",", "2"}], "]"}], "]"}], "//", "Length"}], "//", 
  "Timing"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"uniquePairings", "[", 
    RowBox[{"Array", "[", 
     RowBox[{"a", ",", "4"}], "]"}], "]"}], "//", "Length"}], "//", 
  "Timing"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"uniquePairings", "[", 
    RowBox[{"Array", "[", 
     RowBox[{"a", ",", "6"}], "]"}], "]"}], "//", "Length"}], "//", 
  "Timing"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"uniquePairings", "[", 
    RowBox[{"Array", "[", 
     RowBox[{"a", ",", "8"}], "]"}], "]"}], "//", "Length"}], "//", 
  "Timing"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"uniquePairings", "[", 
    RowBox[{"Array", "[", 
     RowBox[{"a", ",", "10"}], "]"}], "]"}], "//", "Length"}], "//", 
  "Timing"}]}], "Input",
 CellChangeTimes->{{3.704572657247129*^9, 3.704572705806574*^9}, {
  3.7053426027715673`*^9, 3.7053426573757677`*^9}, {3.706465767307047*^9, 
  3.706465773780992*^9}}]
}, Open  ]],

Cell[CellGroupData[{

Cell[TextData[{
 "Here is the actual operator function. \n\nThe first pattern is linearity, \
which should be familiar by now.\n\nThe two following patterns matches two \
edge cases, which simplifies matching of the general case.\n\nThe fourth \
pattern extracts anything not involving r outside the integral.\n\nFinally \
the fifth rule matches ",
 Cell[BoxData[
  FormBox[
   RowBox[{
    RowBox[{
     RowBox[{
      SubscriptBox["r", "i"], 
      SubscriptBox["r", "j"]}], "..."}], 
    SubscriptBox["r", "n"]}], TraditionalForm]],
  FormatType->"TraditionalForm"],
 " and implements the formula above."
}], "Subsubsection",
 CellChangeTimes->{{3.706465849832415*^9, 3.706466142170817*^9}, {
  3.706466834759733*^9, 3.70646684296163*^9}}],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"angularIntegral", "[", "ex_Plus", "]"}], ":=", 
   RowBox[{"Map", "[", 
    RowBox[{"angularIntegral", ",", "ex"}], "]"}]}], " ", 
  RowBox[{"(*", " ", "linearity", " ", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"angularIntegral", "[", "1", "]"}], ":=", 
   RowBox[{"4", "Pi", " ", 
    RowBox[{"invr", "[", 
     RowBox[{"-", "2"}], "]"}]}]}], " ", 
  RowBox[{"(*", " ", 
   RowBox[{"trivial", " ", "integral"}], " ", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"angularIntegral", "[", 
    RowBox[{"r", "[", "_", "]"}], "]"}], ":=", "0"}], "  ", 
  RowBox[{"(*", " ", 
   RowBox[{"trivial", " ", "integral"}], " ", "*)"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"angularIntegral", "[", 
    RowBox[{"extra_", " ", 
     RowBox[{"(", 
      RowBox[{"withr_:", "1"}], ")"}]}], "]"}], ":=", 
   RowBox[{
    RowBox[{"contractNoRenumber", "[", 
     RowBox[{"extra", " ", 
      RowBox[{"angularIntegral", "[", "withr", "]"}]}], "]"}], "/;", 
    RowBox[{"FreeQ", "[", 
     RowBox[{"extra", ",", "r"}], "]"}]}]}], 
  RowBox[{"(*", " ", 
   RowBox[{"take", " ", "everything", " ", "except", " ", 
    RowBox[{"r", "[", "_idx", "]"}], " ", "outside", " ", "the", " ", 
    "angular", " ", "integral"}], " ", "*)"}], "\[IndentingNewLine]", 
  "\[IndentingNewLine]", 
  RowBox[{"(*", " ", 
   RowBox[{
    RowBox[{"integral", " ", "of", " ", 
     RowBox[{"r", "[", "i_", "]"}], 
     RowBox[{"r", "[", "j_", "]"}]}], "..."}], " ", 
   "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"angularIntegral", "[", 
    RowBox[{"HoldPattern", "[", 
     RowBox[{"rs", ":", 
      RowBox[{"Times", "[", 
       RowBox[{
        RowBox[{"r", "[", "_", "]"}], ".."}], "]"}]}], "]"}], "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"rindices", ",", "numr", ",", " ", "integral"}], "}"}], ",", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"rindices", "=", 
       RowBox[{"Cases", "[", 
        RowBox[{
         RowBox[{"List", "@@", "rs"}], ",", 
         RowBox[{
          RowBox[{"r", "[", 
           RowBox[{"i", ":", "_idx"}], "]"}], "\[RuleDelayed]", "i"}]}], 
        "]"}]}], ";", " ", 
      RowBox[{"(*", " ", 
       RowBox[{"list", " ", "indices", " ", "of", " ", "r"}], " ", "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{"numr", "=", 
       RowBox[{"Length", "[", "rindices", "]"}]}], ";", "\[IndentingNewLine]",
       "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
        RowBox[{"odd", " ", "integral"}], " ", "=", " ", "0"}], " ", "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"OddQ", "[", "numr", "]"}], ",", 
        RowBox[{"Return", "[", "0", "]"}]}], "]"}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{"even", " ", 
        RowBox[{"integral", ":", " ", 
         RowBox[{
         "form", " ", "all", " ", "permutations", " ", "of", " ", "deltas", 
          " ", "with", " ", "rindices", " ", "and", " ", "the", " ", 
          "prefactors"}]}]}], " ", "*)"}], "\[IndentingNewLine]", 
      RowBox[{"integral", "=", 
       RowBox[{
        RowBox[{
         RowBox[{"(", 
          FractionBox[
           RowBox[{"4", " ", "\[Pi]"}], 
           RowBox[{"1", "+", "numr"}]], ")"}], "/", 
         RowBox[{"(", 
          FractionBox[
           RowBox[{
            SuperscriptBox["2", 
             RowBox[{"numr", "/", "2"}]], " ", 
            RowBox[{"Gamma", "[", 
             RowBox[{
              FractionBox["1", "2"], "+", 
              FractionBox["numr", "2"]}], "]"}]}], 
           SqrtBox["\[Pi]"]], ")"}]}], 
        RowBox[{"Sum", "[", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"Product", "[", 
           RowBox[{
            RowBox[{"delta", "[", 
             RowBox[{
              RowBox[{"pp", "[", 
               RowBox[{"[", "1", "]"}], "]"}], ",", 
              RowBox[{"pp", "[", 
               RowBox[{"[", "2", "]"}], "]"}]}], "]"}], ",", 
            RowBox[{"{", 
             RowBox[{"pp", ",", "p"}], "}"}]}], "]"}], ",", 
          "\[IndentingNewLine]", 
          RowBox[{"{", 
           RowBox[{"p", ",", 
            RowBox[{"uniquePairings", "[", "rindices", "]"}]}], "}"}]}], 
         "]"}]}]}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"invr", "[", 
        RowBox[{
         RowBox[{"-", "numr"}], "-", "2"}], "]"}], "integral"}]}]}], 
    "\[IndentingNewLine]", "]"}]}], "\[IndentingNewLine]", 
  "\[IndentingNewLine]", 
  RowBox[{"(*", " ", 
   RowBox[{"Common", " ", 
    RowBox[{"application", ":", " ", 
     RowBox[{"integral", " ", "over", " ", "unit", " ", "sphere"}]}]}], " ", 
   "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"unitsphereIntegral", "[", "ex_", "]"}], ":=", 
   RowBox[{
    RowBox[{
     RowBox[{"angularIntegral", "[", "ex", "]"}], "/.", 
     RowBox[{
      RowBox[{"invr", "[", "_", "]"}], "\[RuleDelayed]", "1"}]}], "//", 
    "contractNoRenumber"}]}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
  RowBox[{"(*", " ", "examples", " ", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{"42", "//", "unitsphereIntegral"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"r", "[", 
   RowBox[{"idx", "[", "1", "]"}], "]"}], "//", 
  "unitsphereIntegral"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"r", "[", 
     RowBox[{"idx", "[", "1", "]"}], "]"}], 
    RowBox[{"r", "[", 
     RowBox[{"idx", "[", "2", "]"}], "]"}]}], "//", "unitsphereIntegral"}], "//",
   "prettyprint"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"r", "[", 
     RowBox[{"idx", "[", "1", "]"}], "]"}], 
    RowBox[{"r", "[", 
     RowBox[{"idx", "[", "2", "]"}], "]"}], 
    RowBox[{"r", "[", 
     RowBox[{"idx", "[", "3", "]"}], "]"}], 
    RowBox[{"r", "[", 
     RowBox[{"idx", "[", "4", "]"}], "]"}]}], "//", "unitsphereIntegral"}], "//",
   "prettyprint"}]}], "Input",
 CellChangeTimes->{{3.706465882397606*^9, 3.706465883292822*^9}, {
  3.706465925138711*^9, 3.7064659270213537`*^9}, {3.706466148720632*^9, 
  3.7064662838022013`*^9}, {3.706470521197173*^9, 3.706470539324748*^9}, {
  3.706470640691176*^9, 3.7064706704804163`*^9}, {3.706470860707849*^9, 
  3.706470869084749*^9}, {3.7072478490612392`*^9, 3.707247852988401*^9}}]
}, Open  ]]
}, Open  ]],

Cell[CellGroupData[{

Cell["Volume integral", "Section",
 CellChangeTimes->{{3.706470554038892*^9, 3.706470578609124*^9}, {
  3.7064706219788227`*^9, 3.706470629695426*^9}}],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"fluidVolumeIntegral", "[", "ex_", "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"x", ",", "a"}], "}"}], ",", "\n", 
     RowBox[{
      RowBox[{"a", "=", 
       RowBox[{
        RowBox[{"contractNoRenumber", "[", 
         RowBox[{"angularIntegral", "[", "ex", "]"}], "]"}], "/.", 
        RowBox[{
         RowBox[{"invr", "[", "m_", "]"}], "\[RuleDelayed]", 
         RowBox[{"1", "/", 
          RowBox[{"x", "^", "m"}]}]}]}]}], ";", "\n", 
      RowBox[{
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"Head", "[", "a", "]"}], "===", "Plus"}], ",", "\n", 
         RowBox[{"Map", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"Integrate", "[", 
             RowBox[{"#", " ", ",", 
              RowBox[{"{", 
               RowBox[{"x", ",", "1", ",", "Infinity"}], "}"}]}], "]"}], 
            "&"}], ",", "a"}], "]"}], "\n", ",", "\n", 
         RowBox[{"Integrate", "[", 
          RowBox[{"a", " ", ",", 
           RowBox[{"{", 
            RowBox[{"x", ",", "1", ",", "Infinity"}], "}"}]}], "]"}]}], "\n", 
        "]"}], "//", "contract"}]}]}], "\n", "]"}]}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"r", "[", 
    RowBox[{"idx", "[", "1", "]"}], "]"}], 
   RowBox[{"r", "[", 
    RowBox[{"idx", "[", "2", "]"}], "]"}], 
   RowBox[{"r", "[", 
    RowBox[{"idx", "[", "3", "]"}], "]"}], 
   RowBox[{"r", "[", 
    RowBox[{"idx", "[", "4", "]"}], "]"}], 
   RowBox[{"invr", "[", "10", "]"}]}], "//", 
  "fluidVolumeIntegral"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"10", " ", 
   RowBox[{"r", "[", 
    RowBox[{"idx", "[", "1", "]"}], "]"}], 
   RowBox[{"r", "[", 
    RowBox[{"idx", "[", "2", "]"}], "]"}], 
   RowBox[{"invr", "[", "8", "]"}]}], "//", "fluidVolumeIntegral"}]}], "Input",\

 CellChangeTimes->{{3.7064705814494534`*^9, 3.706470589670567*^9}, {
  3.706470631916572*^9, 3.706470632316597*^9}, {3.706470689006246*^9, 
  3.706470738716593*^9}}]
}, Open  ]]
}, Open  ]]
},
WindowSize->{1211, 610},
WindowMargins->{{Automatic, 33}, {Automatic, 50}},
FrontEndVersion->"11.0 for Mac OS X x86 (32-bit, 64-bit Kernel) (September \
21, 2016)",
StyleDefinitions->"Default.nb"
]
(* End of Notebook Content *)

(* Internal cache information *)
(*CellTagsOutline
CellTagsIndex->{}
*)
(*CellTagsIndex
CellTagsIndex->{}
*)
(*NotebookFileOutline
Notebook[{
Cell[558, 20, 184, 4, 64, "Section",
 InitializationCell->True],
Cell[CellGroupData[{
Cell[767, 28, 142, 2, 66, "Title",
 InitializationCell->True],
Cell[CellGroupData[{
Cell[934, 34, 129, 2, 63, "Subchapter",
 InitializationCell->True],
Cell[CellGroupData[{
Cell[1088, 40, 137, 2, 44, "Subsection",
 InitializationCell->True],
Cell[1228, 44, 1168, 33, 168, "Input",
 InitializationCell->True]
}, Closed]],
Cell[CellGroupData[{
Cell[2433, 82, 212, 3, 36, "Subsection",
 InitializationCell->True],
Cell[2648, 87, 16504, 397, 1713, "Input",
 InitializationCell->True]
}, Closed]]
}, Open  ]],
Cell[CellGroupData[{
Cell[19201, 490, 142, 2, 63, "Subchapter",
 InitializationCell->True],
Cell[CellGroupData[{
Cell[19368, 496, 129, 2, 44, "Subsection",
 InitializationCell->True],
Cell[19500, 500, 4650, 123, 327, "Input",
 InitializationCell->True]
}, Closed]],
Cell[CellGroupData[{
Cell[24187, 628, 127, 2, 36, "Subsection",
 InitializationCell->True],
Cell[24317, 632, 4588, 123, 537, "Input",
 InitializationCell->True]
}, Closed]],
Cell[CellGroupData[{
Cell[28942, 760, 185, 3, 36, "Subsection",
 InitializationCell->True],
Cell[29130, 765, 2622, 73, 306, "Input",
 InitializationCell->True]
}, Closed]]
}, Open  ]],
Cell[CellGroupData[{
Cell[31801, 844, 181, 3, 63, "Subchapter",
 InitializationCell->True],
Cell[CellGroupData[{
Cell[32007, 851, 170, 2, 44, "Subsection",
 InitializationCell->True],
Cell[32180, 855, 3628, 90, 264, "Input",
 InitializationCell->True]
}, Closed]],
Cell[CellGroupData[{
Cell[35845, 950, 130, 2, 36, "Subsection",
 InitializationCell->True],
Cell[35978, 954, 5570, 136, 831, "Input",
 InitializationCell->True]
}, Closed]],
Cell[CellGroupData[{
Cell[41585, 1095, 156, 2, 36, "Subsection",
 InitializationCell->True],
Cell[41744, 1099, 2650, 66, 432, "Input",
 InitializationCell->True]
}, Closed]]
}, Open  ]]
}, Open  ]],
Cell[CellGroupData[{
Cell[44455, 1172, 119, 1, 92, "Title"],
Cell[44577, 1175, 2162, 79, 149, "Subsubsection"],
Cell[CellGroupData[{
Cell[46764, 1258, 103, 1, 50, "Section"],
Cell[CellGroupData[{
Cell[46892, 1263, 2405, 71, 296, "Subsubsection"],
Cell[49300, 1336, 1166, 35, 54, "Input"]
}, Open  ]],
Cell[CellGroupData[{
Cell[50503, 1376, 710, 14, 63, "Subsubsection"],
Cell[51216, 1392, 896, 28, 54, "Input"]
}, Open  ]],
Cell[CellGroupData[{
Cell[52149, 1425, 425, 7, 35, "Subsubsection"],
Cell[52577, 1434, 2686, 80, 222, "Input"]
}, Open  ]],
Cell[CellGroupData[{
Cell[55300, 1519, 742, 18, 231, "Subsubsection"],
Cell[56045, 1539, 6470, 173, 714, "Input"]
}, Open  ]]
}, Open  ]],
Cell[CellGroupData[{
Cell[62564, 1718, 151, 2, 64, "Section"],
Cell[62718, 1722, 2059, 58, 243, "Input"]
}, Open  ]]
}, Open  ]]
}
]
*)

